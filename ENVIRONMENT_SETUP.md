# Environment Setup Guide

This document provides complete instructions for setting up all required environment variables for the Moltbot-Render project.

## Required Environment Variables

### 1. Google/Gemini API Key (REQUIRED)

OpenClaw needs this to run the AI agent.

**Get your API key:**
1. Go to [Google AI Studio](https://makersuite.google.com/app/apikey)
2. Click "Create API Key"
3. Copy the key (starts with `AIza...`)

**Set in Render:**
```bash
GEMINI_API_KEY=AIzaSyXXXXXXXXXXXXXXXXXXXXXX
GOOGLE_API_KEY=AIzaSyXXXXXXXXXXXXXXXXXXXXXX  # Same value as above
```

**Important:** Both variables should have the same value. OpenClaw looks for `GOOGLE_API_KEY`, but we use `GEMINI_API_KEY` for clarity.

---

### 2. Brave Search API Key (RECOMMENDED)

For high-quality web search functionality.

**Get your API key:**
1. Go to [Brave Search API](https://brave.com/search/api/)
2. Sign up for a free account
3. Choose "Data for Search" plan (free tier: 2,000 requests/month)
4. Generate an API key (starts with `BSA...`)

**Set in Render:**
```bash
BRAVE_API_KEY=BSAXXXXXXXXXXXXXXXXXXXXXXXXXX
```

**If not set:** OpenClaw will fall back to built-in search, which has lower quality results.

---

### 3. Database & Cache (REQUIRED)

#### Supabase Database
Store user credentials and audit logs.

**Get your credentials:**
1. Go to [Supabase Dashboard](https://supabase.com/dashboard)
2. Create a project (or use existing)
3. Go to Settings → API
4. Copy "URL" and "service_role key"

**Set in Render:**
```bash
SUPABASE_URL=https://YOUR-PROJECT.supabase.co
SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### Upstash Redis
For session management and rate limiting.

**Get your credentials:**
1. Go to [Upstash Console](https://console.upstash.com/)
2. Create a Redis database (or use existing)
3. Copy "Endpoint" and "Password"

**Set in Render:**
```bash
UPSTASH_REDIS_URL=https://YOUR-DB.upstash.io
UPSTASH_REDIS_TOKEN=AYXXXXXXXXXXXXXXXXXXxxx
```

---

### 4. Google OAuth (REQUIRED for Gmail & Calendar)

For users to connect their Google accounts.

**Get your credentials:**
1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a project (or use existing)
3. Enable these APIs:
   - Gmail API
   - Google Calendar API
4. Go to "Credentials" → "Create Credentials" → "OAuth client ID"
5. Choose "Web application"
6. Add authorized redirect URI:
   ```
   https://moltbot-fastapi.onrender.com/api/v1/oauth/google/callback
   ```
7. Copy "Client ID" and "Client Secret"

**Set in Render:**
```bash
GOOGLE_CLIENT_ID=1234567890-xxxxxxxxxxxxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-xxxxxxxxxxxxxxxxxxx
GOOGLE_REDIRECT_URI=https://moltbot-fastapi.onrender.com/api/v1/oauth/google/callback
```

**Important:** The redirect URI must match exactly what you set in Google Cloud Console.

---

### 5. Encryption & Security (AUTO-GENERATED)

These are automatically generated by Render.

```bash
ENCRYPTION_KEY=<auto-generated>
API_SECRET_KEY=<auto-generated>
```

**Do not set manually.** Render will generate secure random values.

---

### 6. Service URLs (AUTO-CONFIGURED)

```bash
MOLTBOT_GATEWAY_URL=https://openclaw-gateway-dg3y.onrender.com
PEPPI_WEBSITE_URL=https://peppi.app
```

These are set in [render.yaml](render.yaml) and should match your actual deployment URLs.

---

## Complete Environment Variable Checklist

Use this checklist when setting up Render environment variables:

### OpenClaw Gateway Service

- [ ] `GEMINI_API_KEY` - Google AI API key (required)
- [ ] `GOOGLE_API_KEY` - Same as GEMINI_API_KEY (required)
- [ ] `BRAVE_API_KEY` - Brave Search API key (recommended)
- [ ] `NODE_VERSION` - Set to "22" (auto-configured)
- [ ] `NODE_OPTIONS` - Set to "--max-old-space-size=2048" (auto-configured)

### FastAPI Wrapper Service

- [ ] `SUPABASE_URL` - Supabase project URL (required)
- [ ] `SUPABASE_KEY` - Supabase service role key (required)
- [ ] `UPSTASH_REDIS_URL` - Upstash Redis endpoint (required)
- [ ] `UPSTASH_REDIS_TOKEN` - Upstash Redis token (required)
- [ ] `GOOGLE_CLIENT_ID` - OAuth client ID (required)
- [ ] `GOOGLE_CLIENT_SECRET` - OAuth client secret (required)
- [ ] `GOOGLE_REDIRECT_URI` - OAuth redirect URI (required)
- [ ] `MOLTBOT_GATEWAY_URL` - OpenClaw gateway URL (auto-configured)
- [ ] `ENCRYPTION_KEY` - Auto-generated by Render
- [ ] `API_SECRET_KEY` - Auto-generated by Render
- [ ] `PYTHON_VERSION` - Set to "3.11.0" (auto-configured)

---

## Testing Environment Variables

After setting all variables, test each service:

### Test OpenClaw Gateway
```bash
curl https://openclaw-gateway-dg3y.onrender.com/health
```

**Expected response:**
```json
{
  "status": "online",
  "service": "openclaw-gateway",
  "openclaw_ready": true
}
```

### Test FastAPI Wrapper
```bash
curl https://moltbot-fastapi.onrender.com/health
```

**Expected response:**
```json
{
  "code": 200,
  "message": "Service health check completed",
  "data": {
    "status": "healthy",
    "openclaw_gateway": "online",
    "redis": true,
    "supabase": true,
    "active_sessions": 0
  }
}
```

### Test Diagnostics
```bash
curl https://openclaw-gateway-dg3y.onrender.com/diagnose
```

This will show which environment variables are set correctly.

---

## Troubleshooting

### OpenClaw Gateway Not Starting

**Check logs for:**
```
❌ GEMINI_API_KEY not set - OpenClaw will NOT work!
```

**Solution:** Set `GEMINI_API_KEY` in Render environment variables.

---

### Web Search Not Working

**Check logs for:**
```
⚠ BRAVE_API_KEY not set (using built-in web search)
```

**Solution:** Get a free Brave Search API key and set `BRAVE_API_KEY`.

---

### Gmail/Calendar Not Working

**Possible causes:**
1. User hasn't connected Google account via OAuth
2. OAuth credentials not set correctly
3. Gmail/Calendar APIs not enabled in Google Cloud

**Solution:**
1. Verify `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `GOOGLE_REDIRECT_URI` are set
2. Enable Gmail API and Calendar API in Google Cloud Console
3. Test OAuth flow: `https://moltbot-fastapi.onrender.com/api/v1/oauth/google/init`

---

### Redis Connection Failed

**Check logs for:**
```
Redis not configured - sessions will not persist
```

**Solution:** Set `UPSTASH_REDIS_URL` and `UPSTASH_REDIS_TOKEN` correctly.

---

### Database Connection Failed

**Check logs for:**
```
Failed to initialize database
```

**Solution:** Verify `SUPABASE_URL` and `SUPABASE_KEY` are correct. Ensure database tables are created (see [migrations](fastapi-wrapper/migrations/)).

---

## Security Best Practices

1. **Never commit API keys to Git**
   - Use Render's environment variables
   - Use `.env.example` for documentation only

2. **Rotate keys periodically**
   - Google API keys
   - OAuth client secrets
   - Database credentials

3. **Use service role keys for Supabase**
   - Not the anon public key
   - Service role key has full access

4. **Monitor API usage**
   - Google AI Studio dashboard
   - Brave Search API dashboard
   - Upstash Redis dashboard

---

## Next Steps

After setting up environment variables:

1. Deploy to Render
2. Check service logs for any errors
3. Test health endpoints
4. Run through [TESTING_GUIDE.md](TESTING_GUIDE.md)
5. Test with actual user via Peppi SMS

---

## Support Resources

- [OpenClaw Documentation](https://docs.openclaw.ai/)
- [Brave Search API Docs](https://brave.com/search/api/)
- [Google Cloud Console](https://console.cloud.google.com/)
- [Supabase Dashboard](https://supabase.com/dashboard)
- [Upstash Console](https://console.upstash.com/)
- [Render Documentation](https://render.com/docs)
